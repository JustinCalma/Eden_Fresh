title Archiving Failure Scenario

participant "archivingManager : ArchivingManager" as control
participant "archivingService : ArchivingService" as service
participant "logGateway : SQLLogGateway" as reader
participant "SQL Server" as logs
participant "archiveGateway : CompressingFileSystemLogGateway" as writer
participant "Web Host File System" as archive

#Instantiations (Dependency injection)
activate control
control->reader:new SQLLogGateway(String serverConnectionString)
activate reader
reader->reader:Constructor
reader-->control:SQLLogGateway instance
deactivate reader
control->writer:new CompressingFileSystemLogGateway(String fileLocation)
activate writer
writer->writer:Constructor
writer-->control:CompressingFileSystemLogGateway instance
deactivate writer
control->service:new ArchivingService(logGateway : ILogGateway, archiveGateway : ILogGateway)
activate service
service->service:Constructor
service-->control:ArchivingService instance
deactivate service
#Methods Begin
control-->control:waitForArchive()
note right of control:waitForArchive() waits until 00:00:00 AM local time\non the first of the month then calls the next method. 
control->service: archivingService.archiveData(minimumAge : int, tableName : String)
activate service
service->service: Get timestamp of date 30 days ago
service->reader:logGateway.readLogsWhere(columnName : String, comparator : Enum, value : String)
activate reader
reader->reader:Build SQL SELECT query with timestamp string
reader->logs:SELECT statement
activate logs
logs-->reader:Selected rows
deactivate logs
reader->reader:Verify that deleted rows satisfy readLogsWhere() comparison
reader-->service:readLogs : DataTable
deactivate reader
service->writer:archiveGateway.writeLogs(logs : DataTable)
activate writer
writer->archive:New .txt file
note left of archive: it is not fully successful
archive-->writer: Fail - only few logs added
activate archive
writer->writer:Iterate through readLogs rows
loop n < logs.size
writer->archive:Write nth row of readLogs to .txt file
archive-->writer: Fail - only few logs added
end
writer->archive:Compress .txt file to .zip file
archive-->writer: Fail - only few logs added
deactivate archive
writer-->service: false
service-->control:false
deactivate service
control-->control:waitForArchive()
